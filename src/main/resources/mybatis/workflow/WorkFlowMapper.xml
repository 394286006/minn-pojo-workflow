<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="p.minn.workflow.repository.WorkFlowDao">
	
	<select id="queryTree" resultType="java.util.HashMap">
	  select id as id,id as rid,(select max(name) from globalization where tablename='department' and tablecolumn='name' and tableid=department.id) as text , pid,pid as rpid,0 as selected,'department' as type from department
		
	</select>
	
	<select id="queryModelTree" resultType="java.util.HashMap">
	select pd.id,pd.pid,pd.pn_id as pnId,(select max(name) from globalization where tablename='wf_processdefinition' and tablecolumn='name' and language=#{lang} and tableid=pd.id) as text,(select max(url) from wf_processnode where id=pn_id) as url ,(case pd.sort when 1 then 1 else 0 end) as selected from wf_processdefinition  pd where pd.id 
	like '${condition.id}%'  order by pd.sort asc
	</select>
	<!-- 
	<select id="getNextStep" resultType="java.util.HashMap">
	  select max(concat(pd.pid,'_',pn.id)) as pdnId,pd.pn_id from wf_processdefinition pd inner join wf_processnodemodel pn on pd.pn_id=pn.pn_id  where pn.pn_id=${pnId}  and  concat(pd.pid,'_',pn.id)
	   not in(select pdn_id from wf_audit_status where processstatus=1 and lp_id=${lpId} and maxactive=${maxActive})
	</select>
	 -->
	<select id="getNextStep" resultType="java.util.HashMap">
	 select ${fun}(concat(pd.pid,'_',pn.id)) as pdnId,pd.pn_id,pd.id as pdId from wf_processdefinition pd inner join wf_processnodemodel pn on pd.pn_id=pn.pn_id  where 
    concat(pd.pid,'_',pn.id) not in (select pdn_id from wf_audit_status where lp_id=${lpId} and status=1 and maxactive=${maxActive})
	and pd.sort=(
	 select min(pd.sort) from wf_processdefinition pd inner join wf_processnodemodel pn on pd.pn_id=pn.pn_id  where 
	 concat(pd.pid,'_',pn.id) not in (select pdn_id from wf_audit_status where lp_id=${lpId} and status=1 and maxactive=${maxActive})
	)
	</select>
	
	<select id="getNodeCompleteNum" resultType="java.lang.Integer">
	 select (
		select  count(id) num from wf_processnodemodel where pn_id=${pnId}) -
		(select count(id) num from wf_audit_status where  lp_id=${lpId} and pdn_id like '${pdId}%' and maxactive=(select max(maxactive) from wf_audit_status where lp_id=${lpId} and pdn_id like '${pdId}%')
		) as num
	</select>
	
	
</mapper>